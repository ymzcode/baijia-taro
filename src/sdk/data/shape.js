var loadMap,eventEmitter=require("../eventEmitter"),$=require("../jquery"),util=require("../util");function getLoadKey(e){return e.docId+"-"+e.page}function getShapeList(e){return loadMap[getLoadKey(e)]}exports.init=function(){loadMap={},eventEmitter.on(eventEmitter.RECORD_SHAPE_CLEAN,function(){loadMap={}}).on(eventEmitter.PAGE_DELETE,function(e,t){var r=t.docId+"-"+t.pageId;r&&delete loadMap[r]})},exports.add=function(e,t,r){var a=exports.get(e,t);if($.isArray(a)){$.isArray(r)||(r=[r]);var o=util.toObject(a,"id");$.each(r,function(e,t){o[t.id]||a.push(t)})}},exports.remove=function(e,t,r){var a=exports.get(e,t);if($.isArray(a)){var o=-1;$.each(a,function(e,t){if(t.id===r)return o=e,!1}),o>=0&&a.splice(o,1)}},exports.update=function(e,t,r){var a=getShapeList({docId:e,page:t});if($.isArray(a)){$.isArray(r)||(r=[r]);var o=util.toObject(a,"id");$.each(r,function(e,t){var r=o[t.id];r&&$.extend(r,t)})}},exports.get=function(e,t){return getShapeList({docId:e,page:t})},exports.clear=function(e,t){if(null!=e&&null!=t){var r=exports.get(e,t),a=getLoadKey({docId:e,page:t});$.isArray(r)&&(r.length=0,loadMap[a]=[])}else loadMap={}},exports.load=function(e,t){var r={docId:e,page:t},a=getLoadKey(r),o=loadMap[a]||{},i=$.Deferred(),n=function(e){i.resolve(e)};return o.done?o:($.isArray(o)?n(o):(loadMap[a]=i,eventEmitter.one(eventEmitter.SHAPE_ALL_RES,function(e,t){if(t.docId===r.docId&&t.page===r.page){var o=t.shapeList;loadMap[a]=o,exports.add(r.docId,r.page,o),n(o)}}).trigger(eventEmitter.SHAPE_ALL_REQ,r)),i)};