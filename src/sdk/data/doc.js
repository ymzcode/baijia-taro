var toNumber=require("../function/toNumber"),config=require("../config"),storage=require("../storage"),$=require("../jquery"),util=require("../util"),eventEmitter=require("../eventEmitter"),raw=[],settings={},LOCAL_DOC_QUALITY="bjy_doc_image_quality",LOCAL_DOC_FIT="bjy_doc_image_fit";function getDocumentById(e){var t;return $.each(raw,function(r,n){if(e==n.id)return t=n,!1}),t}function simple2Complex(e){var t,r,n=0;return $.each(raw,function(o,i){if(r=n+i.pageList.length,e>=n&&e<r)return t=i,!1;n=r}),{docId:t.id,page:e-n,pptUrl:t.pptUrl,pageList:t.pageList}}function complex2Simple(e,t){var r={page:-1};return $.each(raw,function(n,o){if(o.id==e)return r.pptUrl=o.pptUrl,r.page+=t+1,!1;r.page+=o.pageList.length}),r}exports.init=function(){exports.clear(),settings.quality=config.DOC_QUALITY_LOW,settings.fit=toNumber(storage.get(LOCAL_DOC_FIT),config.DOC_FIT_VIEW)},exports.getRawDocList=function(){return raw},exports.clear=function(){raw=[]},exports.isWhiteboardDoc=function(e){return"0"===e},exports.add=function(e){$.isArray(e)||(e=[e]),$.merge(raw,e)},exports.update=function(e,t){getDocumentById(e).extra=t},exports.remove=function(e){var t;return $.each(raw,function(r,n){n.id==e&&(t=r)}),t>=0&&raw.splice(t,1)[0]},exports.getQuality=function(){return settings.quality},exports.setQuality=function(e){settings.quality=e},exports.getFit=function(){return settings.fit},exports.setFit=function(e){settings.fit=e,storage.set(LOCAL_DOC_FIT,e)},exports.getWhiteboardPageCount=function(){var e=0;return $.each(exports.getWhiteboardList(),function(t,r){e+=r.pageList.length}),e},exports.getWhiteboardDocCount=function(){return exports.isWhiteboardDoc(raw[0]&&raw[0].id)?1:0},exports.getDocumentCount=function(){var e=0;return $.each(exports.getDocumentList(),function(t,r){e+=r.pageList.length}),e},exports.getWhiteboardList=function(){return raw.slice(0,exports.getWhiteboardDocCount())},exports.getDocumentList=function(){return raw.slice(exports.getWhiteboardDocCount())},exports.getPageInfoByPage=function(e){var t=simple2Complex(e);return exports.getPageInfoByDoc(t.docId,t.page)},exports.getDocumentById=getDocumentById,exports.getPageInfoByDoc=function(e,t){return getDocumentById(e).pageList[t]},exports.getDocumentById=function(e,t){return getDocumentById(e)},exports.getSimplePage=function(e,t){return complex2Simple(e,t)},exports.getComplexPage=function(e){return simple2Complex(e)},exports.getPageById=function(e,t){var r=getDocumentById(e);if(r){var n=r.pageInfo.pageIds;if(util.is.array(n)){var o=util.array.indexOf(n,t);if(o>-1)return o}}return 0},exports.getIdByPage=function(e,t){if(exports.isWhiteboardDoc(e)){var r=exports.getPageInfoByDoc(e,t);return r?r.pageId:-1}return t},exports.getLocalPage=function(e,t){return exports.isWhiteboardDoc(e)?exports.getPageById(e,t):t},exports.getServerPage=function(e,t){return exports.isWhiteboardDoc(e)?exports.getIdByPage(e,t):t},exports.addPage=function(e,t){var r=getDocumentById(e),n=r.pageInfo;r.pageList.push({width:n.width,height:n.height,url:n.url,pageId:t});var o=n.pageIds;o||(o=[]),o.push(t),n.pageIds=o,n.totalPages=n.totalPages+1,eventEmitter.trigger(eventEmitter.PAGE_ADD,{docId:e,pageId:t,page:exports.getPageById(e,t)})},exports.deletePage=function(e,t){var r=getDocumentById(e);if(r){var n=r.pageInfo,o=r.pageList,i=exports.getPageById(e,t);o.length>1&&i>-1&&(o.splice(i,1),n.pageIds&&n.pageIds.splice(i,1),n.totalPages=n.totalPages-1,eventEmitter.trigger(eventEmitter.PAGE_DELETE,{docId:e,pageId:t,page:i}))}},exports.getTotalPages=function(){return exports.getDocumentCount()+exports.getWhiteboardPageCount()},exports.setScale=function(e){scale=e},exports.setScale=function(e){scale=e},exports.getScale=function(){return scale},exports.getCanTurningPage=function(){return canTurningPage},exports.setCanTurningPage=function(e){e!=canTurningPage&&(canTurningPage=e,eventEmitter.trigger(eventEmitter.CAN_TURNING_PAGE_CHANGE,{canTurningPage:e}))},exports.getPageChangeStatus=function(){return pageChangeStatus},exports.setPageChangeStatus=function(e){pageChangeStatus=e};