var $=require("../jquery"),STATUS_NONE=0,STATUS_OPEN=1,STATUS_ERROR=2,STATUS_CLOSE=3,STATUS_TIMEOUT=4,STATUS_CONNECTING=5,noop=function(){};function WebSocket(t){$.extend(this,t),this.status=STATUS_NONE,t.retryCount>0&&(this.retryIndex=0)}var proto=WebSocket.prototype;proto.isOpen=function(){return this.status===STATUS_OPEN},proto.isConnecting=function(){return this.status===STATUS_CONNECTING},proto.connect=function(t,o){var n=this;if(n.status!==STATUS_OPEN&&n.status!==STATUS_CONNECTING){var e=[t];o&&o.length&&(e=e.concat(o));var s=-1,r=function(){var t,o,r,S,u;n.status===STATUS_CONNECTING&&(t=e[++s],o=function(t,o,r){if(n.status===STATUS_CONNECTING)if(r===STATUS_OPEN)n.url=o.url,n.socket=t,n.status=STATUS_OPEN,t.onMessage(function(t){n.status===STATUS_OPEN&&n.onReceive(JSON.parse(t.data))}),t.onClose(function(){console.log("socket closed",n.url,arguments),n.onClose&&n.onClose(),n.socket=null,n.status=STATUS_CLOSE}),n.retryCount>0&&(n.retryIndex=0),n.onOpen&&n.onOpen({server:o});else if(s===e.length-1){if(n.retryCount>0&&n.retryIndex++<n.retryCount)return s=-1,void T();switch(n.status=r){case STATUS_ERROR:n.onError&&n.onError();break;case STATUS_TIMEOUT:n.onTimeout&&n.onTimeout()}}else T()},S=wx.connectSocket({url:t.url}),u=function(n){r&&clearTimeout(r),S.onOpen(noop),S.onError(noop),o(S,t,n)},S.onOpen(function(){u(STATUS_OPEN)}),S.onError(function(){console.log("socket error",arguments),u(STATUS_ERROR)}),n.timeout>0&&(r=setTimeout(function(){r=null,u(STATUS_TIMEOUT)},n.timeout)))},T=function(){n.interval>0?setTimeout(r,n.interval):r()};n.status=STATUS_CONNECTING,r()}},proto.send=function(t){var o=this.socket;o&&(o.send({data:"string"==typeof t?t:JSON.stringify(t)}),this.onSend&&this.onSend(t))},proto.close=function(){var t=this,o=$.Deferred(),n=this.socket;return this.socket=null,this.status=STATUS_CLOSE,n?(n.onMessage(noop),n.onClose(noop),n.close(),n.onClose(function(){t.onClose&&t.onClose(),o.resolve()})):o.resolve(),o},module.exports=WebSocket;