!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.Canvas=e()}(this,function(){"use strict";var t={each:function(t,e,i){var n=t.length;if(n)if(i)for(var o=n-1;o>=0&&!1!==e(t[o],o);o--);else for(var r=0;r<n&&!1!==e(t[r],r);r++);},push:function(t,e){t.push(e)},pop:function(t){t.pop()},remove:function(t,e){var i=t.indexOf(e);if(i>=0)return t.splice(i,1),!0},last:function(t){return t[t.length-1]},has:function(t,e){return t.indexOf(e)>=0}},e=function(t,e){if(!(t instanceof e))throw new Error("Cannot call a class as a function")},i=function(t,e){if("function"!=typeof e&&null!==e)throw new Error("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)},n=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e};function o(e,i){t.each(Object.keys(e),function(t){return i(e[t],t)})}var r={each:o,copy:function e(i,n){var r=i;return Array.isArray(i)?(r=[],t.each(i,function(t,i){r[i]=n?e(t,n):t})):i&&"object"==typeof i&&(r={},o(i,function(t,i){r[i]=n?e(t,n):t})),r},extend:function(t,e){return e&&o(e,function(e,i){t[i]=e}),t}},s=function(){function t(i,n){e(this,t),r.extend(this,i),this.emitter=n,this.state=!0}return t.prototype.on=function(t,e){return this.emitter.on(t,e,!0),this},t.prototype.off=function(t,e){return this.emitter.off(t,e),this},t.prototype.destroy=function(){},t.prototype.draw=function(){},t}(),h=wx.getSystemInfoSync().pixelRatio,a={DEVICE_PIXEL_RATIO:h,STROKE_POSITION_INSIDE:1,STROKE_POSITION_CENTER:2,STROKE_POSITION_OUTSIDE:3,SIZE_MIN:6*h},p=function(){function i(){e(this,i);var t,n,o,r,s,h,p,c=this,f={},l={};c.listeners={};var y=function(e){s=e.pageX,h=e.pageY,t=s-f.x,n=h-f.y,container&&(t+=container.scrollLeft,n+=container.scrollTop),o=t*a.DEVICE_PIXEL_RATIO,r=n*a.DEVICE_PIXEL_RATIO},d=function(t){var e=t.touches;y(e?e[0]:t)},E=function(t,e){p&&c.fire(t,e)};f.x=f.y=l.x=l.y=0;var S=function(e){if(!c.disabled&&!e.button){if(p)return void v();d(e),E(i.MOUSE_DOWN,{x:o,y:r,realX:t,realY:n,pageX:s,pageY:h,target:e.target,inCanvas:void 0})}},v=function(){c.disabled||(E(i.MOUSE_UP,{x:o,y:r,realX:t,realY:n,pageX:s,pageY:h,inCanvas:void 0}),p&&(p=!1))},x="undefined"!=typeof document?document:null;if(x){var _={},g=function(t,e){x&&(x.addEventListener(t,e),_[t]=e)};g("mousedown",S),g("mousemove",function(e){c.disabled||(y(e),E(i.MOUSE_MOVE,{x:o,y:r,realX:t,realY:n,pageX:s,pageY:h,inCanvas:!!p||void 0}))}),g("mouseup",v),"ontouchstart"in x&&(g("touchstart",S),g("touchmove",function(e){c.disabled||(d(e),E(i.MOUSE_MOVE,{x:o,y:r,realX:t,realY:n,pageX:s,pageY:h,inCanvas:!!p||void 0}))}),g("touchend",v)),u&&g("keyup",function(t){if(!c.disabled){var e=u[t.keyCode];e&&c.fire(e)}}),this.documentEvents=_,this.canvasEvents={}}}return i.prototype.fire=function(e,i){var n=this.listeners[e];n&&t.each(n,function(t){if(t)return t(i)})},i.prototype.on=function(t,e,i){var n=this.listeners[t]||(this.listeners[t]=[]);return i?n.unshift(e):n.push(e),this},i.prototype.off=function(e,i){var n=this.listeners[e];return n&&t.remove(n,i),this},i.prototype.dispose=function(){},i}();p.RESET="reset",p.CLEAR="clear",p.MOUSE_DOWN="mouse_down",p.MOUSE_MOVE="mouse_move",p.MOUSE_UP="mouse_up",p.SHAPE_ENTER="shape_enter",p.SHAPE_LEAVE="shape_leave",p.HOVER_SHAPE_CHANGE="hover_shape_change",p.ACTIVE_SHAPE_CHANGE="active_shape_change",p.ACTIVE_SHAPE_DELETE="active_shape_delete",p.ACTIVE_SHAPE_ENTER="active_shape_enter",p.ACTIVE_RECT_CHANGE_START="active_rect_change_start",p.ACTIVE_RECT_CHANGE_END="active_rect_change_end",p.ACTIVE_DRAG_BOX_HOVER="active_drag_box_hover",p.SELECTION_RECT_CHANGE="selection_rect_change",p.SELECTION_START="selection_start",p.SELECTION_END="selection_end",p.SHAPE_DRAWING_START="shape_drawing_start",p.SHAPE_DRAWING="shape_drawing",p.SHAPE_DRAWING_END="shape_drawing_end",p.SHAPE_ADD="shape_add",p.SHAPE_REMOVE="shape_remove",p.SHAPE_UPDATE="shape_update";var u={8:p.ACTIVE_SHAPE_DELETE,13:p.ACTIVE_SHAPE_ENTER,36:p.CLEAR,46:p.ACTIVE_SHAPE_DELETE};function c(t,e,i){return function(n,o){e<n?(t.x=e,t.width=n-e):(t.x=n,t.width=e-n),i<o?(t.y=i,t.height=o-i):(t.y=o,t.height=i-o)}}var f=function(t){function o(i,r){e(this,o);var s,h=n(this,t.call(this,i,r)),a=h;return a.mouseDownHandler=function(t){if(!s&&t.inCanvas){var e=c(a,t.x,t.y);r.fire(p.SELECTION_START);var i=function(t){e(t.x,t.y),r.fire(p.SELECTION_RECT_CHANGE,{rect:a})},n=function(){r.off(p.MOUSE_MOVE,i),r.off(p.MOUSE_UP,n),r.off(p.RESET,n),a.x=a.y=a.width=a.height=e=null,r.fire(p.SELECTION_END)};r.on(p.MOUSE_MOVE,i).on(p.MOUSE_UP,n).on(p.RESET,n)}},a.shapeEnterHandler=function(t){s=t.shape},a.shapeLeaveHandler=function(){s&&(s=null)},a.on(p.MOUSE_DOWN,a.mouseDownHandler).on(p.SHAPE_ENTER,a.shapeEnterHandler).on(p.SHAPE_LEAVE,a.shapeLeaveHandler),h}return i(o,t),o.prototype.destroy=function(){this.off(p.MOUSE_DOWN,this.mouseDownHandler).off(p.SHAPE_ENTER,this.shapeEnterHandler).off(p.SHAPE_LEAVE,this.shapeLeaveHandler)},o.prototype.isPointInPath=function(t,e,i){return!1},o.prototype.draw=function(t){var e=this.x,i=this.y,n=this.width,o=this.height;n&&o&&(t.disableShadow(),t.setLineWidth(1),t.setStrokeStyle("#ccc"),t.setFillStyle("rgba(180,180,180,0.1)"),t.begin(),t.drawRect(e+.5,i+.5,n,o),t.stroke(),t.fill())},o}(s);var l=0,y=1,d=2,E=3,S=4,v=5,x=6,_=7;function g(t){return!!t.toJSON().fontSize}var w=function(o){function s(i,r,h){e(this,s);var a,u,f,g,w,I,P=n(this,o.call(this,i,r)),T=P;T.shapes=[];var A=function(){I=T.shapes.map(function(t){return t.save(T)})};return T.clearHandler=function(){T.setShapes(h,[])},T.shapeEnterHandler=function(t){var e=t.shape;e.state||(w=e)},T.shapeLeaveHandler=function(){w&&(w=null)},T.mouseDownHandler=function(e){if(a>=0){var i=T.x,n=T.y,o=i+T.width,r=n+T.height;switch(a){case l:g=c(T,o,r);break;case y:u=i,g=c(T,o,r);break;case d:g=c(T,i,r);break;case E:f=r,g=c(T,i,n);break;case S:g=c(T,i,n);break;case v:u=o,g=c(T,i,n);break;case x:g=c(T,o,n);break;case _:f=r,g=c(T,o,n)}A()}else if(w){t.has(T.shapes,w)||T.setShapes(h,[w]);var s=e.x-T.x,p=e.y-T.y;g=function(t,e){T.x=t-s,T.y=e-p},A()}else e.inCanvas&&T.shapes.length&&T.setShapes(h,[])},T.mouseMoveHandler=function(e){if(g)return g(u||e.x,f||e.y),r.fire(p.ACTIVE_RECT_CHANGE_START),t.each(T.shapes,function(t,e){t.restore(T,I[e])}),void r.fire(p.ACTIVE_RECT_CHANGE_END);var i,n=T.isPointInPath(h,e.x,e.y);if(!1!==n){if(a!==n)switch(a=n,n){case y:case v:i="ns";break;case E:case _:i="ew";break;case l:case S:i="nwse";break;case d:case x:i="nesw"}}else a>=0&&(i="",a=-1);null!=i&&r.fire(p.ACTIVE_DRAG_BOX_HOVER,{name:i})},T.mouseUpHandler=function(t){a>=0&&(a=-1,r.fire(p.ACTIVE_DRAG_BOX_HOVER,{name:""})),g=u=f=null},T.resetUpHandler=function(t){a>=0&&T.mouseUpHandler(t),T.setShapes(h,[])},T.on(p.CLEAR,T.clearHandler).on(p.SHAPE_ENTER,T.shapeEnterHandler).on(p.SHAPE_LEAVE,T.shapeLeaveHandler).on(p.MOUSE_DOWN,T.mouseDownHandler).on(p.MOUSE_MOVE,T.mouseMoveHandler).on(p.MOUSE_UP,T.mouseUpHandler).on(p.RESET,T.resetUpHandler),P}return i(s,o),s.prototype.destroy=function(){this.off(p.CLEAR,this.clearHandler).off(p.SHAPE_ENTER,this.shapeEnterHandler).off(p.SHAPE_LEAVE,this.shapeLeaveHandler).off(p.MOUSE_DOWN,this.mouseDownHandler).off(p.MOUSE_MOVE,this.mouseMoveHandler).off(p.MOUSE_UP,this.mouseUpHandler).off(p.RESET,this.resetUpHandler)},s.prototype.getShapes=function(){return this.shapes},s.prototype.setShapes=function(t,e){if(e.length>0){var i=function(t){var e=t.length;if(!e)throw new Error("getUnionRect rects array length have to be large than 1.");for(var i=t[0],n=i.x,o=i.y,r=n+i.width,s=o+i.height,h=1;h<e;h++)(i=t[h]).x<n&&(n=i.x),i.y<o&&(o=i.y),i.x+i.width>r&&(r=i.x+i.width),i.y+i.height>s&&(s=i.y+i.height);return{x:n,y:o,width:r-n,height:s-o}}(e.map(function(e){return e.getRect(t)}));r.extend(this,i)}else this.width=this.height=0;this.shapes=e,this.emitter.fire(p.ACTIVE_SHAPE_CHANGE,{shapes:e})},s.prototype.isPointInPath=function(t,e,i){var n=this.boxes,o=this.thumbSize;if(n)for(var r,s,h=0,a=n.length;h<a;h+=2)if(r=n[h],s=n[h+1],e>=r-o&&e<=r+2*o&&i>=s-o&&i<=s+2*o)return h/2;return!1},s.prototype.draw=function(e){var i,n=this.shapes,o=this.x,r=this.y,s=this.width,h=this.height,p=n.length;if(p&&(e.disableShadow(),e.setLineWidth(1),p>1?(i=!0,e.setStrokeStyle("#C0CED8"),t.each(n,function(t){var n=t.getRect(e);e.strokeRect(n.x+.5,n.y+.5,n.width,n.height),i&&!g(t)&&(i=!1)})):i=g(n[0]),e.setStrokeStyle("#ccc"),e.begin(),e.drawRect(o+.5,r+.5,s,h),e.stroke(),!i)){e.setStrokeStyle("#a2a2a2"),e.enableShadow(0,2,3,"rgba(0,0,0,0.2)");for(var u,c=this.thumbSize=6*a.DEVICE_PIXEL_RATIO,f=o-c/2,l=o+(s-c)/2,y=o+s-c/2,d=r-c/2,E=r+(h-c)/2,S=r+h-c/2,v=[f,d,l,d,y,d,y,E,y,S,l,S,f,S,f,E],x=0,_=v.length;x<_;x+=2)o=v[x],r=v[x+1],(u=e.createLinearGradient(o,r+c,o,r)).addColorStop(0,"#d6d6d6"),u.addColorStop(1,"#f9f9f9"),e.begin(),e.setFillStyle(u),e.drawRect(o,r,c,c),e.stroke(),e.fill();this.boxes=v,e.disableShadow()}},s}(s),I=function(o){function r(i,s){e(this,r);var h,a,u=n(this,o.call(this,i,s)),c=u;return c.shapeEnterHandler=function(e){var i=e.shape;a||i.state||h&&t.has(h,i)||(c.shape=i,s.fire(p.HOVER_SHAPE_CHANGE,{shape:i}))},c.shapeLeaveHandler=function(){c.shape&&(c.shape=null,s.fire(p.HOVER_SHAPE_CHANGE,{shape:null}))},c.drawingStartHandler=function(){a=!0},c.drawingEndHandler=function(){a=!1},c.activeShapeChangeHandler=function(e){h=e.shapes,t.has(h,c.shape)&&(c.shape=null)},c.resetHandler=function(){c.shape=null},c.on(p.SHAPE_ENTER,c.shapeEnterHandler).on(p.SHAPE_LEAVE,c.shapeLeaveHandler).on(p.SHAPE_DRAWING_START,c.drawingStartHandler).on(p.SHAPE_DRAWING_END,c.drawingEndHandler).on(p.ACTIVE_SHAPE_CHANGE,c.activeShapeChangeHandler).on(p.RESET,c.resetHandler),u}return i(r,o),r.prototype.destroy=function(){this.off(p.SHAPE_ENTER,this.shapeEnterHandler).off(p.SHAPE_LEAVE,this.shapeLeaveHandler).off(p.SHAPE_DRAWING_START,this.drawingStartHandler).off(p.SHAPE_DRAWING_END,this.drawingEndHandler).off(p.ACTIVE_SHAPE_CHANGE,this.activeShapeChangeHandler).off(p.RESET,this.resetHandler)},r.prototype.isPointInPath=function(t,e,i){return!1},r.prototype.draw=function(t){var e=this.shape,i=this.hoverThickness,n=this.hoverColor;e&&(t.disableShadow(),t.setLineWidth(i*a.DEVICE_PIXEL_RATIO),t.setStrokeStyle(n),t.begin(),e.drawPath(t),t.stroke())},r}(s),P=function(t){function o(i,r,s){e(this,o);var h,a,u,c,f=n(this,t.call(this,i,r)),l=f;return l.mouseDownHandler=function(t){t.inCanvas&&(a=0,u=Math.floor(t.x),c=Math.floor(t.y),(h=new l.createShape).startDrawing&&!1===h.startDrawing(s,r,t)?h=null:(s.save(),r.fire(p.SHAPE_DRAWING_START,{cursor:"crosshair"})))},l.mouseMoveHandler=function(t){h&&h.drawing&&(a++,h.drawing(s,u,c,Math.floor(t.x),Math.floor(t.y)),r.fire(p.SHAPE_DRAWING,{shape:h}))},l.mouseUpHandler=function(){if(h){if(h.endDrawing)return void h.endDrawing();s.restore(),r.fire(p.SHAPE_DRAWING_END,{shape:a>0?h:null}),h=null}},l.on(p.MOUSE_DOWN,l.mouseDownHandler).on(p.MOUSE_MOVE,l.mouseMoveHandler).on(p.MOUSE_UP,l.mouseUpHandler).on(p.RESET,l.mouseUpHandler),f}return i(o,t),o.prototype.destroy=function(){this.off(p.MOUSE_DOWN,this.mouseDownHandler).off(p.MOUSE_MOVE,this.mouseMoveHandler).off(p.MOUSE_UP,this.mouseUpHandler).off(p.RESET,this.mouseUpHandler)},o.prototype.isPointInPath=function(t,e,i){return!1},o}(s);function T(e,i,n,o,r){var s=o/i,h=r/n;1===s&&1===h||t.each(e,function(e){1!==s&&(e.x&&(e.x*=s),e.width&&(e.width*=s),e.fontSize&&(e.computeFontSize||(e.computeFontSize=e.fontSize),e.computeFontSize=e.computeFontSize*s,e.computeFontSize<1.5?e.fontSize=1.5:e.fontSize=e.computeFontSize)),1!==h&&(e.y&&(e.y*=h),e.height&&(e.height*=h)),e.points&&t.each(e.points,function(t){t.x&&(t.x*=s),t.y&&(t.y*=h)})})}var A=function(t,e){return e?A(H(H(O(t))),e-1):t},O=function(t){var e=[],i=0,n=t=[t[0]].concat(t).concat(R(t)),o=Array.isArray(n),r=0;for(n=o?n:n[Symbol.iterator]();;){var s;if(o){if(r>=n.length)break;s=n[r++]}else{if((r=n.next()).done)break;s=r.value}var h=s;e[2*i]=h,t[i+1]&&(e[2*i+1]=m(h,t[i+1])),i+=1}return e},H=function(t){var e=[],i=0,n=t,o=Array.isArray(n),r=0;for(n=o?n:n[Symbol.iterator]();;){var s;if(o){if(r>=n.length)break;s=n[r++]}else{if((r=n.next()).done)break;s=r.value}var h=s;t[i+1]&&(e[i]=m(h,t[i+1])),i+=1}return e},m=function(t,e){return{x:t.x+(e.x-t.x)/2,y:t.y+(e.y-t.y)/2}};function R(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return e?Array.prototype.slice.call(t,Math.max(t.length-e,0)):t[t.length-1]}function N(t,e){var i=(e=e||{}).order||3,n=e.tailSize||3,o=Math.pow(2,i),r=n+1,s=null;return t.forEach(function(e,h){var a=t.slice(0,h+1);if(!s||a.length<r)s=A(a,i);else{var p=R(A(R(a,r),i),o*n);s=s.slice(0,s.length-o*(n-1)).concat(p)}}),s}var C=function(){function t(i,n,o){e(this,t),this.context=i,this.width=n,this.height=o}return t.prototype.getCanvasSize=function(){return{width:this.width,height:this.height}},t.prototype.begin=function(){this.context.beginPath()},t.prototype.close=function(){this.context.closePath()},t.prototype.drawRect=function(t,e,i,n){this.context.rect(t,e,i,n)},t.prototype.drawOval=function(t,e,i,n){var o=this.context;if(i===n){var r=i/2;o.moveTo(t+r,e),o.arc(t,e,r,0,2*Math.PI,!0)}else{var s=this.context;if(i===n){var h=i/2;s.moveTo(t+h,e),s.arc(t,e,h,0,2*Math.PI,!0)}else{var a=i/.75/2,p=n/2,u=[{x:t,y:e-p},{x:t+a,y:e-p},{x:t+a,y:e+p},{x:t,y:e+p},{x:t-a,y:e+p},{x:t-a,y:e-p}];s.moveTo(u[0].x,u[0].y),s.bezierCurveTo(u[1].x,u[1].y,u[2].x,u[2].y,u[3].x,u[3].y),s.bezierCurveTo(u[4].x,u[4].y,u[5].x,u[5].y,u[0].x,u[0].y)}var c=i/.75/2,f=n/2;s.moveTo(t,e-f),s.bezierCurveTo(t+c,e-f,t+c,e+f,t,e+f),s.bezierCurveTo(t-c,e+f,t-c,e-f,t,e-f)}},t.prototype.drawPoints=function(t,e){var i=this;if(t.length>1){var n=t;e&&(n=N(t));var o=n[0];this.moveTo(o.x,o.y),n.forEach(function(t){i.lineTo(t.x,t.y)})}},t.prototype.stroke=function(){this.context.stroke()},t.prototype.draw=function(t){this.context.draw(t)},t.prototype.fill=function(){this.context.fill()},t.prototype.strokeRect=function(t,e,i,n){this.context.strokeRect(t,e,i,n)},t.prototype.fillRect=function(t,e,i,n){this.context.fillRect(t,e,i,n)},t.prototype.strokeText=function(t,e,i){this.context.strokeText(i,t,e)},t.prototype.fillText=function(t,e,i){this.context.fillText(i,t,e)},t.prototype.measureText=function(t){return this.context.measureText(t)},t.prototype.isPointInPath=function(t,e){return this.context.isPointInPath(t,e)},t.prototype.clear=function(){this.context.draw()},t.prototype.moveTo=function(t,e){this.context.moveTo(t,e)},t.prototype.lineTo=function(t,e){this.context.lineTo(t,e)},t.prototype.arc=function(t,e,i,n,o,r){this.context.arc(t,e,i,n,o,r)},t.prototype.bezierCurveTo=function(t,e,i,n,o,r){this.context.bezierCurveTo(t,e,i,n,o,r)},t.prototype.createLinearGradient=function(t,e,i,n){return this.context.createLinearGradient(t,e,i,n)},t.prototype.enableShadow=function(t,e,i,n){return this.context.setShadow(t,e,i,n)},t.prototype.disableShadow=function(){},t.prototype.save=function(){this.context.save()},t.prototype.restore=function(t){this.context.restore()},t.prototype.setFont=function(t,e,i,n){this.context.setFontSize(t)},t.prototype.setLineWidth=function(t){this.context.setLineWidth(t)},t.prototype.setLineJoin=function(t){this.context.setLineJoin(t)},t.prototype.setLineCap=function(t){this.context.setLineCap(t)},t.prototype.setStrokeStyle=function(t){this.context.setStrokeStyle(t)},t.prototype.setFillStyle=function(t){this.context.setFillStyle(t)},t}();function M(t,e,i,n,o,r,s){if(!o)return!1;var h=o/2;if(r>t+h&&r>i+h||r<t-h&&r<i-h||s>e+h&&s>n+h||s<e-h&&s<n-h)return!1;if(t===i)return Math.abs(r-t)<=h;var a=(n-e)/(i-t),p=(t*n-i*e)/(t-i);return Math.pow(a*r-s+p,2)/(a*a+1)<=Math.pow(h,2)}function b(t,e,i){return e>=t.x&&e<=t.x+t.width&&i>=t.y&&i<=t.y+t.height}function D(t){return t&&"transparent"!==t}var L=function(){function i(t){e(this,i),r.extend(this,t)}return i.prototype.isPointInPath=function(t,e,i){var n=this.getRect(t);return n.width||(n.x-=a.SIZE_MIN/2,n.width=a.SIZE_MIN),n.height||(n.y-=a.SIZE_MIN/2,n.height=a.SIZE_MIN),!!b(n,e,i)&&(D(this.fillStyle)&&this.isPointInFill?this.isPointInFill(t,e,i):this.isPointInStroke(t,e,i))},i.prototype.isPointInStroke=function(t,e,i){var n=this.lineWidth,o=this.points;n<a.SIZE_MIN&&(n=a.SIZE_MIN);for(var r=0,s=o.length;r<s;r++)if(o[r+1]&&M(o[r].x,o[r].y,o[r+1].x,o[r+1].y,n*a.DEVICE_PIXEL_RATIO,e,i))return!0;return!1},i.prototype.draw=function(t){var e=this.fill&&D(this.fillStyle),i=this.lineWidth&&D(this.strokeStyle);(e||i)&&(e&&(i||this.applyShadow(t),this.fill(t)),i&&(this.applyShadow(t),this.setLineStyle(t),this.stroke(t)),t.draw(!0))},i.prototype.drawPath=function(t){t.drawPoints(this.points)},i.prototype.stroke=function(t){t.setLineWidth(this.lineWidth),t.setStrokeStyle(this.strokeStyle),t.begin(),this.drawPath(t),this.autoClosePath&&t.close(),t.stroke()},i.prototype.applyShadow=function(t){this.shadowColor?t.enableShadow(this.shadowOffsetX,this.shadowOffsetY,this.shadowBlur,this.shadowColor):t.disableShadow()},i.prototype.setLineStyle=function(t){},i.prototype.save=function(t){return this.points.map(function(e){return{x:(e.x-t.x)/t.width,y:(e.y-t.y)/t.height}})},i.prototype.restore=function(e,i){t.each(this.points,function(t,n){t.x=e.x+e.width*i[n].x,t.y=e.y+e.height*i[n].y})},i.prototype.getRect=function(){return function(t){var e=t.length,i=0,n=0,o=0,r=0;if(e>0){var s=t[0];i=o=s.x,n=r=s.y;for(var h=1;h<e;h++)(s=t[h]).x<i?i=s.x:s.x>o&&(o=s.x),s.y<n?n=s.y:s.y>r&&(r=s.y)}return{x:i,y:n,width:o-i,height:r-n}}(this.points)},i.prototype.clone=function(){return new this.constructor(r.copy(this,!0))},i.prototype.toJSON=function(t){var e={number:this.number,lineWidth:this.lineWidth,strokeStyle:this.strokeStyle,fillStyle:this.fillStyle};return this.points&&(e.points=this.points),t&&r.extend(e,t),e},i}();function k(t,e,i,n,o,r){if(r>e&&r>n||r<e&&r<n)return 0;if(n===e)return 0;var s=n<e?1:-1,h=(r-e)/(n-e);return 1!==h&&0!==h||(s=n<e?.5:-.5),h*(i-t)+t>o?s:0}var V=1e-8;function U(t,e){return Math.abs(t-e)<V}function W(e,i){for(var n=[],o=e.length,r=e[o-1].x,s=e[o-1].y,h=0;h<o;h++){var a=e[h],p=a.x,u=a.y,c=(h+1)%o,f=e[c].x,l=e[c].y,y=p-r,d=u-s,E=Math.sqrt(y*y+d*d);d/=E;var S=p-f,v=u-l,x=(y/=E)+(S/=E=Math.sqrt(S*S+v*v)),_=d+(v/=E),g=y*(x/=E=Math.sqrt(x*x+_*_))+d*(_/=E),w=Math.sqrt(1-g*g);t.push(n,{x:p+i*x/w,y:u+i*_/w}),r=p,s=u}return n}function G(t,e,i,n){var o=i-t,r=n-e;return Math.sqrt(o*o+r*r)}function z(t,e,i,n){return{x:Math.floor(t+i*Math.cos(n)),y:Math.floor(e+i*Math.sin(n))}}var F=2*Math.PI,X=function(o){function r(){return e(this,r),n(this,o.apply(this,arguments))}return i(r,o),r.prototype.isPointInFill=function(t,e,i){return function(t,e,i){var n=0,o=t[0];if(!o)return!1;for(var r=1;r<t.length;r++){var s=t[r];n+=k(o.x,o.y,s.x,s.y,e,i),o=s}var h=t[0];return U(o.x,h.x)&&U(o.y,h.y)||(n+=k(o.x,o.y,h.x,h.y,e,i)),0!==n}(this.points,e,i)},r.prototype.drawPath=function(t){t.drawPoints(this.points),t.close()},r.prototype.stroke=function(t){var e=this.points,i=this.strokePosition,n=this.lineWidth,o=this.strokeStyle;n/=a.DEVICE_PIXEL_RATIO,t.setLineWidth(n),t.setStrokeStyle(o),t.begin(),i===a.STROKE_POSITION_INSIDE?e=W(e,n/-2):i===a.STROKE_POSITION_OUTSIDE&&(e=W(e,n/2)),t.drawPoints(e),t.close(),t.stroke()},r.prototype.fill=function(t){t.setFillStyle(this.fillStyle),t.begin(),this.drawPath(t),t.fill()},r.prototype.drawing=function(e,i,n,o,r,s){s();var h=this.count,a=G(i,n,o,r),p=F/h,u=[],c=Math.atan2(r-n,o-i),f=c+F;do{t.push(u,z(i,n,a,c)),c+=p}while(c<=f);u.length-h==1&&t.pop(u),this.points=u,this.draw(e)},r.prototype.validate=function(){var t=this.getRect();return t.width>5&&t.height>5},r.prototype.toJSON=function(){return o.prototype.toJSON.call(this,{name:"Polygon"})},r}(L);var J=Math.PI/180,Y=function(o){function r(){return e(this,r),n(this,o.apply(this,arguments))}return i(r,o),r.prototype.drawing=function(e,i,n,o,r,s){s();var h,a=this.thickness,p=G(i,n,o,r),u=20*a;p<u?(a*=p/u,h=p/3):(h=p/8)>50&&(h=50);var c=[],f=this.double,l=.5*h,y=function(e){t.push(c,e),e={x:e.x+p-h,y:e.y},f&&(e.x-=h),t.push(c,e),t.push(c,z(e.x,e.y,l,250*J)),t.push(c,{x:i+p,y:n})};if(f){t.push(c,{x:i,y:n});var d={x:i+h,y:n-a};t.push(c,z(d.x,d.y,l,290*J)),y(d)}else y({x:i,y:n-a});for(var E=c.length-2;E>=0;E--)c.push({x:c[E].x,y:2*n-c[E].y});this.points=function(t,e,i,n){return n.map(function(n){return{x:Math.floor((n.x-t)*Math.cos(i)-(n.y-e)*Math.sin(i)+t),y:Math.floor((n.x-t)*Math.sin(i)+(n.y-e)*Math.cos(i)+e)}})}(i,n,Math.atan2(r-n,o-i),c),this.draw(e)},r.prototype.toJSON=function(){return o.prototype.toJSON.call(this,{name:"Polygon"})},r}(X),K=function(t){function o(){return e(this,o),n(this,t.apply(this,arguments))}return i(o,t),o.prototype.setLineStyle=function(t){t.setLineJoin("round"),t.setLineCap("round")},o.prototype.drawing=function(t,e,i,n,o){var r=this.points||(this.points=[{x:e,y:i}]);t.disableShadow(),t.begin(),1===r.length&&(this.setLineStyle(t),t.setLineWidth(this.lineWidth),t.setStrokeStyle(this.strokeStyle)),r.push({x:n,y:o});var s=Math.pow(2,3),h=r.length,a=N(r,{order:3,tailSize:3});t.drawPoints(a.slice(s*(h-2),s*(h-1)+1)),t.stroke(),t.draw(!0)},o.prototype.drawPath=function(t){t.drawPoints(this.points,!0)},o.prototype.toJSON=function(){return t.prototype.toJSON.call(this,{name:"Doodle"})},o}(L),Z=function(t,e,i){return t+e*(16*Math.pow(Math.sin(i),3))},j=function(t,e,i){return t-e*(13*Math.cos(i)-5*Math.cos(2*i)-2*Math.cos(3*i)-Math.cos(4*i))},q=Math.PI,B=2*q,Q=function(o){function r(){return e(this,r),n(this,o.apply(this,arguments))}return i(r,o),r.prototype.drawing=function(e,i,n,o,r,s){s(),this.x=i,this.y=n,this.width=this.height=2*G(i,n,o,r);var h=G(i,0,o,0),a=[],p=h/32,u=q,c=B/Math.max(16*p,30),f=-q;t.push(a,{x:Z(this.x+h/2,p,u),y:j(this.y,p,u)});do{t.push(a,{x:Z(this.x+h/2,p,u),y:j(this.y,p,u)}),u-=c}while(u>=f);this.points=a,this.draw(e)},r.prototype.validate=function(){return this.width>5&&this.height>5},r.prototype.toJSON=function(){return o.prototype.toJSON.call(this,{name:"Polygon"})},r}(X),$=function(t){function o(){return e(this,o),n(this,t.apply(this,arguments))}return i(o,t),o.prototype.setLineStyle=function(t){t.setLineCap("square")},o.prototype.drawing=function(t,e,i,n,o,r){r(),(this.points||(this.points=[{x:e,y:i}]))[1]={x:n,y:o},this.draw(t)},o.prototype.validate=function(){var t=this.points;return t&&2===t.length},o.prototype.toJSON=function(){return t.prototype.toJSON.call(this,{name:"Doodle"})},o}(L),tt=function(t){function o(){return e(this,o),n(this,t.apply(this,arguments))}return i(o,t),o.prototype.isPointInFill=function(t,e,i){return t.begin(),this.drawPath(t),t.isPointInPath(e,i)},o.prototype.isPointInStroke=function(t,e,i){var n=this.x,o=this.y,r=this.width,s=this.height,h=(this.strokeStyle,this.strokePosition),p=this.lineWidth;p<a.SIZE_MIN&&(p=a.SIZE_MIN);var u=2*p;switch(t.begin(),h){case a.STROKE_POSITION_OUTSIDE:if(t.drawOval(n,o,r+u,s+u),t.isPointInPath(e,i))return t.begin(),t.drawOval(n,o,r,s),!t.isPointInPath(e,i);case a.STROKE_POSITION_CENTER:if(t.drawOval(n,o,r+p,s+p),t.isPointInPath(e,i))return r-=p,s-=p,t.begin(),t.drawOval(n,o,r,s),!t.isPointInPath(e,i);break;case a.STROKE_POSITION_INSIDE:if(t.drawOval(n,o,r,s),t.isPointInPath(e,i))return r-=u,s-=u,t.begin(),t.drawOval(n,o,r,s),!t.isPointInPath(e,i)}return!1},o.prototype.drawPath=function(t){t.drawOval(this.x,this.y,this.width,this.height)},o.prototype.stroke=function(t){var e=this.x,i=this.y,n=this.width,o=this.height,r=this.strokeStyle,s=this.strokePosition,h=this.lineWidth;if(s===a.STROKE_POSITION_INSIDE){if(o-=h,(n-=h)<0||o<0)return}else s===a.STROKE_POSITION_OUTSIDE&&(n+=h,o+=h);t.setLineWidth(h/a.DEVICE_PIXEL_RATIO),t.setStrokeStyle(r),t.begin(),t.drawOval(e,i,n,o),t.stroke()},o.prototype.fill=function(t){t.setFillStyle(this.fillStyle),t.begin(),this.drawPath(t),t.fill()},o.prototype.drawing=function(t,e,i,n,o,r){r(),this.x=e,this.y=i,this.width=this.height=2*G(e,i,n,o),this.draw(t)},o.prototype.save=function(t){return{x:(this.x-t.x)/t.width,y:(this.y-t.y)/t.height,width:this.width/t.width,height:this.height/t.height}},o.prototype.restore=function(t,e){this.x=t.x+t.width*e.x,this.y=t.y+t.height*e.y,this.width=t.width*e.width,this.height=t.height*e.height},o.prototype.validate=function(){return this.width>5&&this.height>5},o.prototype.getRect=function(){var t=this.x,e=this.y,i=this.width,n=this.height;return{x:t-i/2,y:e-n/2,width:i,height:n}},o.prototype.toJSON=function(){return t.prototype.toJSON.call(this,{name:"Oval",x:this.x,y:this.y,width:this.width,height:this.height})},o}(L);var et,it,nt=function(t){function o(){return e(this,o),n(this,t.apply(this,arguments))}return i(o,t),o.prototype.drawing=function(t,e,i,n,o,r){r();var s=this.points||(this.points=[]),h=function(t,e,i,n){var o,r,s,h;return t<i?(o=t,s=i-t):(o=i,s=t-i),e<n?(r=e,h=n-e):(r=n,h=e-n),{x:o,y:r,width:s,height:h}}(e,i,n,o);s[0]={x:h.x,y:h.y},s[1]={x:h.x+h.width,y:h.y},s[2]={x:h.x+h.width,y:h.y+h.height},s[3]={x:h.x,y:h.y+h.height},this.draw(t)},o.prototype.toJSON=function(){return t.prototype.toJSON.call(this,{name:"Polygon"})},o}(X),ot=2*Math.PI,rt=function(o){function r(){return e(this,r),n(this,o.apply(this,arguments))}return i(r,o),r.prototype.drawing=function(e,i,n,o,r,s){s();var h=this.count,a=this.radius,p=G(i,n,o,r),u=ot/h,c=a;c||(c=p/2);var f=[],l=Math.atan2(r-n,o-i),y=l+ot;do{t.push(f,z(i,n,p,l)),t.push(f,z(i,n,c,l+u/2)),l+=u}while(l<=y);f.length-2*h==2&&t.pop(f),this.points=f,this.draw(e)},r.prototype.validate=function(){var t=this.getRect();return t.width>5&&t.height>5},r.prototype.toJSON=function(){return o.prototype.toJSON.call(this,{name:"Polygon"})},r}(X),st="rgba(0,0,0,0)";function ht(t){return t+t/6}function at(t,e){var i=t.fontSize,n=t.fontFamily,o=(t.x,t.y,document.body);(it=document.createElement("p")).style.cssText="\n    position: absolute;\n    visibility: hidden;\n    font: "+i+"px "+n+";\n    line-height: "+ht(i)+"px;\n  ",o.appendChild(it);var r=(e+"").split("\n");""===r[r.length-1]&&(r[r.length-1]="W"),it.innerHTML=r.join("<br>");var s=it,h=s.offsetWidth,a=s.offsetHeight;return o.removeChild(it),{width:h+1,height:a}}var pt=function(o){function r(){return e(this,r),n(this,o.apply(this,arguments))}return i(r,o),r.prototype.isPointInPath=function(t,e,i){return b(this.getRect(t),e,i)},r.prototype.drawPath=function(t){var e=this.getRect(t);t.drawRect(e.x,e.y,e.width,e.height)},r.prototype.fill=function(e){var i=this.x,n=this.y,o=this.text,r=this.fontSize,s=this.fontFamily,h=this.fontItalic,a=this.fontWeight;e.setFillStyle(this.fillStyle),e.setFont(r,s,h,a);var p=r+r/6;t.each(o.split("\n"),function(t,o){e.fillText(i,n+r+p*o,t)})},r.prototype.stroke=function(e){var i=this.x,n=this.y,o=this.text,r=this.fontSize,s=this.fontFamily,h=this.fontItalic,p=this.fontWeight,u=this.lineWidth,c=this.strokeStyle,f=a.DEVICE_PIXEL_RATIO;e.setLineWidth(u),e.setStrokeStyle(c),e.setFont(r*f,s,h,p);var l=r*f+r*f/6;t.each(o.split("\n"),function(t,o){e.strokeText(i,n+r*f+l*o,t)})},r.prototype.startDrawing=function(t,e,i){return et||(this.x=i.x,this.y=i.y,function(t,e,i,n){var o=n.fontSize,r=n.fontFamily,s=(n.x,n.y,n.fontItalic),h=n.fontWeight,u=n.caretColor,c=n.fillStyle,f=document.body,l=at(n,"W").height,y=a.DEVICE_PIXEL_RATIO,d=t.getCanvasSize(),E=d.width,S=d.height,v=(E-n.x)/y,x=(S-n.y)/y;et=document.createElement("textarea");var _="\n    position: absolute;\n    left: "+i.pageX+"px;\n    top: "+i.pageY+"px;\n    color: "+st+";\n    caret-color: "+(u||c)+";\n    background-color: "+st+";\n    font: "+o+"px "+r+";\n    line-height: "+ht(o)+"px;\n    border: 1px dashed "+c+";\n    box-sizing: content-box;\n    outline: none;\n    resize: none;\n    padding: 0;\n    overflow: hidden;\n    width: "+o+"px;\n    height: "+l+"px;\n    max-width: "+v+"px;\n    max-height: "+x+"px;\n    wrap: physical;\n  ";s&&(_+="font-style: italic;"),h&&(_+="font-weight: bold;"),et.style.cssText=_,f.appendChild(et),setTimeout(function(){et.focus()});var g=t.save(),w=!1,I=function(){t.restore(g),n.text=et.value,n.draw(t)},P=function(){var t=at(n,et.value||"W"),e=t.width,i=t.height;et.style.width=e+"px",et.style.height=i+"px",w||I()},T=function(){w=!0},A=function(){w=!1,I()},O=function(){et.removeEventListener("input",P),et.removeEventListener("compositionstart",T),et.removeEventListener("compositionend",A),et.removeEventListener("blur",O),f.removeChild(et),it=et=null,e.fire(p.SHAPE_DRAWING_END,{shape:n})};et.addEventListener("input",P),et.addEventListener("compositionstart",T),et.addEventListener("compositionend",A),et.addEventListener("blur",O),e.fire(p.SHAPE_DRAWING_START,{cursor:"text"}),e.on(p.ACTIVE_SHAPE_ENTER,function(t){et&&(et.style.height=at(n,et.value||"W").height+"px")})}(t,e,i,this)),!1},r.prototype.validate=function(){var t=this.text;return t&&t.trim().length},r.prototype.save=function(t){return{x:(this.x-t.x)/t.width,y:(this.y-t.y)/t.height}},r.prototype.restore=function(t,e){this.x=t.x+t.width*e.x,this.y=t.y+t.height*e.y},r.prototype.getRect=function(t){var e=this.x,i=this.y,n=this.text,o=this.fontSize,r=this.fontFamily,s=this.fontItalic,h=this.fontWeight;t.setFont(o*a.DEVICE_PIXEL_RATIO,r,s,h);var p=at(this,n);return p.x=e,p.y=i,p.width*=a.DEVICE_PIXEL_RATIO,p.height*=a.DEVICE_PIXEL_RATIO,p},r.prototype.toJSON=function(){return o.prototype.toJSON.call(this,{name:"Text",x:this.x,y:this.y,text:this.text,fontSize:this.fontSize,fontFamily:this.fontFamily,fontItalic:this.fontItalic,fontWeight:this.fontWeight})},r}(L),ut=0,ct=function(){function i(n,o,r){var s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:10;e(this,i);var h=this;h.resize(o,r,!0);var a,u=h.painter=new C(n,o,r),c=h.emitter=new p;h.states=[],h.histories=[{}],h.historyIndex=0,h.maxHistorySize=s;var f=function(){h.refresh()};c.on(p.MOUSE_MOVE,function(e){var i;t.each([h.states,h.getShapes()],function(n){if(t.each(n,function(t){if(t&&!1!==t.isPointInPath(u,e.x,e.y))return i=t,!1},!0),i)return!1}),i!==a&&(a&&c.fire(p.SHAPE_LEAVE,{shape:a}),i&&c.fire(p.SHAPE_ENTER,{shape:i}),a=i)}).on(p.HOVER_SHAPE_CHANGE,f).on(p.ACTIVE_SHAPE_CHANGE,f).on(p.ACTIVE_RECT_CHANGE_END,f).on(p.CLEAR,function(){h.clear()}).on(p.ACTIVE_RECT_CHANGE_START,function(){var t=h.states[ut].getShapes();t.length&&h.editShapes(t,null,!0)}).on(p.ACTIVE_SHAPE_DELETE,function(){h.removeActiveShapes()}).on(p.SELECTION_RECT_CHANGE,function(t){h.states[ut].setShapes(u,h.getShapes().filter(function(e){if(function(t,e){var i=Math.max(t.x,e.x),n=Math.max(t.y,e.y),o=Math.min(t.x+t.width,e.x+e.width),r=Math.min(t.y+t.height,e.y+e.height);if(o-i>=0&&r-n>=0)return{x:i,y:n,width:o-i,height:r-n}}(e.getRect(u),t.rect))return!0}))}).on(p.SELECTION_START,function(){}).on(p.SELECTION_END,function(){h.refresh()}).on(p.SHAPE_DRAWING_START,function(t){}).on(p.SHAPE_DRAWING_END,function(t){var e=t.shape;if(e){var i={x:0,y:0,width:h.width,height:h.height};e.validate&&!e.validate(u,i)||h.addShape(e,!0)}})}return i.prototype.resize=function(t,e,i){var n=this.histories,o=this.historyIndex;if(this.width=t,this.height=e,n){var r=n[o];r.shapes&&r.width&&r.height&&T(r.shapes,r.width,r.height,t,e),r.width=t,r.height=e}i||this.refresh()},i.prototype.addShape=function(t,e){this.addShapes([t],e)},i.prototype.addShapes=function(e,i){var n=this.getShapes();if(this.save(),t.each(e,function(e){t.push(n,e)}),i){var o=this.painter;t.each(e,function(t){t&&t.draw(o)})}else this.refresh();this.emitter.fire(p.SHAPE_ADD,{shapes:e})},i.prototype.removeShape=function(t,e){this.removeShapes([t],e)},i.prototype.removeShapes=function(e,i){this.save();var n={};t.each(e,function(t){n[t.number]=1});var o=[],r=this.getShapes();t.each(r,function(t,e){n[t.number]&&(r.splice(e,1),o.push(t))},!0),i||this.refresh(),this.emitter.fire(p.SHAPE_REMOVE,{shapes:o})},i.prototype.removeActiveShapes=function(){var t=this.states[ut];if(t){var e=t.getShapes();e.length&&(this.removeShapes(e,!0),t.setShapes(this.painter,[]))}},i.prototype.editShapes=function(e,i,n){this.save();var o=this.getShapes();t.each(e,function(t,n){var s=o.indexOf(t);if(s>=0){var h=t.clone();i&&r.extend(h,i),o[s]=e[n]=h}}),n||this.refresh(),this.emitter.fire(p.SHAPE_UPDATE,{shapes:e})},i.prototype.getShapes=function(){var t=this.histories[this.historyIndex];return t.shapes||(t.shapes=[])},i.prototype.drawing=function(t){var e=this.states,i=this.emitter,n=this.painter,o=this.config,r=function(t){e[t]&&(e[t].destroy(),e[t]=null)},s=function(t){r(2),e[2]=t};t?(r(ut),r(1),s(new P({createShape:function(){var e,i,n,r=new t(o);return r.number=""+(e=10,i=Math.pow(10,e-1),n=Math.pow(10,e)-1,i+Math.floor(Math.random()*(n-i))),r}},i,n))):!1!==t?(e[ut]||(e[ut]=new w({},i,n)),e[1]||(e[1]=new I(o,i)),s(new f({},i))):(r(ut),r(1),s())},i.prototype.apply=function(t){var e=this.states[ut];if(e){var i=e.getShapes();i.length&&this.editShapes(i,t)}this.config=t},i.prototype.refresh=function(){var e=this.painter;e.clear();var i=function(t){t&&t.draw(e)};t.each(this.getShapes(),i),t.each(this.states,i)},i.prototype.clear=function(){this.removeShapes(this.getShapes())},i.prototype.save=function(){var t=this.histories,e=this.maxHistorySize,i=this.historyIndex;t.length>i+1&&t.splice(i+1);var n={width:this.width,height:this.height,shapes:this.getShapes()};t.length>0?t.splice(t.length,0,n):t.push(r.copy(n),n),t.length>e+1&&t.splice(0,1),this.historyIndex=t.length-1},i.prototype.hasPrev=function(){return!!this.histories[this.historyIndex-1]},i.prototype.prev=function(){if(this.hasPrev()){this.historyIndex--,this.emitter.fire(p.RESET);var t=this.histories[this.historyIndex],e=t.width,i=t.height,n=t.shapes;return n&&T(n,e,i,this.width,this.height),!0}},i.prototype.hasNext=function(){return!!this.histories[this.historyIndex+1]},i.prototype.next=function(){if(this.hasNext()){this.historyIndex++,this.emitter.fire(p.RESET);var t=this.histories[this.historyIndex],e=t.width,i=t.height,n=t.shapes;return n&&T(n,e,i,this.width,this.height),this.refresh(),!0}},i.prototype.dispose=function(){this.emitter.dispose()},i}();return ct.Emitter=p,ct.shapes={Arrow:Y,Doodle:K,Heart:Q,Line:$,Oval:tt,Polygon:X,Rect:nt,Star:rt,Text:pt},ct});