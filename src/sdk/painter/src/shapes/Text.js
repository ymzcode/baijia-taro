import Shape from"./Shape";import containRect from"../contain/rect";import array from"../util/array";import constant from"../constant";import Emitter from"../Emitter";const TRANSPARENT="rgba(0,0,0,0)";let textarea,p;function getLineHeight(t){return t+t/6}function getTextSize(t,e){const{fontSize:n,fontFamily:i,x:o,y:a}=t,r=document.body;(p=document.createElement("p")).style.cssText=`\n    position: absolute;\n    visibility: hidden;\n    font: ${n}px ${i};\n    line-height: ${getLineHeight(n)}px;\n  `,r.appendChild(p);let s=(e+"").split("\n");""===s[s.length-1]&&(s[s.length-1]="W"),p.innerHTML=s.join("<br>");let{offsetWidth:h,offsetHeight:x}=p;return r.removeChild(p),{width:h+1,height:x}}function createTextarea(t,e,n,i){const{fontSize:o,fontFamily:a,x:r,y:s,fontItalic:h,fontWeight:x,caretColor:l,fillStyle:c}=i,f=document.body,d=getTextSize(i,"W").height,g=constant.DEVICE_PIXEL_RATIO,{width:y,height:m}=t.getCanvasSize(),E=(y-i.x)/g,u=(m-i.y)/g;textarea=document.createElement("textarea");let S=`\n    position: absolute;\n    left: ${n.pageX}px;\n    top: ${n.pageY}px;\n    color: ${TRANSPARENT};\n    caret-color: ${l||c};\n    background-color: ${TRANSPARENT};\n    font: ${o}px ${a};\n    line-height: ${getLineHeight(o)}px;\n    border: 1px dashed ${c};\n    box-sizing: content-box;\n    outline: none;\n    resize: none;\n    padding: 0;\n    overflow: hidden;\n    width: ${o}px;\n    height: ${d}px;\n    max-width: ${E}px;\n    max-height: ${u}px;\n    wrap: physical;\n  `;h&&(S+="font-style: italic;"),x&&(S+="font-weight: bold;"),textarea.style.cssText=S,f.appendChild(textarea),setTimeout(function(){textarea.focus()});let T=t.save(),I=!1,v=function(){t.restore(T),i.text=textarea.value,i.draw(t)},R=function(){let{width:t,height:e}=getTextSize(i,textarea.value||"W");textarea.style.width=t+"px",textarea.style.height=e+"px",I||v()},A=function(){I=!0},L=function(){I=!1,v()},_=function(){textarea.removeEventListener("input",R),textarea.removeEventListener("compositionstart",A),textarea.removeEventListener("compositionend",L),textarea.removeEventListener("blur",_),f.removeChild(textarea),p=textarea=null,e.fire(Emitter.SHAPE_DRAWING_END,{shape:i})};textarea.addEventListener("input",R),textarea.addEventListener("compositionstart",A),textarea.addEventListener("compositionend",L),textarea.addEventListener("blur",_),e.fire(Emitter.SHAPE_DRAWING_START,{cursor:"text"}),e.on(Emitter.ACTIVE_SHAPE_ENTER,function(t){textarea&&(textarea.style.height=getTextSize(i,textarea.value||"W").height+"px")})}export default class Text extends Shape{isPointInPath(t,e,n){return containRect(this.getRect(t),e,n)}drawPath(t){const e=this.getRect(t);t.drawRect(e.x,e.y,e.width,e.height)}fill(t){const{x:e,y:n,text:i,fontSize:o,fontFamily:a,fontItalic:r,fontWeight:s}=this;constant.DEVICE_PIXEL_RATIO;t.setFillStyle(this.fillStyle),t.setFont(o,a,r,s);const h=o+o/6;array.each(i.split("\n"),function(i,a){t.fillText(e,n+o+h*a,i)})}stroke(t){const{x:e,y:n,text:i,fontSize:o,fontFamily:a,fontItalic:r,fontWeight:s,lineWidth:h,strokeStyle:x}=this,l=constant.DEVICE_PIXEL_RATIO;t.setLineWidth(h),t.setStrokeStyle(x),t.setFont(o*l,a,r,s);const c=o*l+o*l/6;array.each(i.split("\n"),function(i,a){t.strokeText(e,n+o*l+c*a,i)})}startDrawing(t,e,n){return textarea||(this.x=n.x,this.y=n.y,createTextarea(t,e,n,this)),!1}validate(){const{text:t}=this;return t&&t.trim().length}save(t){return{x:(this.x-t.x)/t.width,y:(this.y-t.y)/t.height}}restore(t,e){this.x=t.x+t.width*e.x,this.y=t.y+t.height*e.y}getRect(t){const{x:e,y:n,text:i,fontSize:o,fontFamily:a,fontItalic:r,fontWeight:s}=this;t.setFont(o*constant.DEVICE_PIXEL_RATIO,a,r,s);let h=getTextSize(this,i);return h.x=e,h.y=n,h.width*=constant.DEVICE_PIXEL_RATIO,h.height*=constant.DEVICE_PIXEL_RATIO,h}toJSON(){return super.toJSON({name:"Text",x:this.x,y:this.y,text:this.text,fontSize:this.fontSize,fontFamily:this.fontFamily,fontItalic:this.fontItalic,fontWeight:this.fontWeight})}};