import State from"./State";import Emitter from"../Emitter";import constant from"../constant";import updateRect from"../function/updateRect";import getUnionRect from"../function/getUnionRect";import array from"../util/array";import object from"../util/object";const LEFT_TOP=0,CENTER_TOP=1,RIGHT_TOP=2,RIGHT_MIDDLE=3,RIGHT_BOTTOM=4,CENTER_BOTTOM=5,LEFT_BOTTOM=6,LEFT_MIDDLE=7;function isTextShape(e){return!!e.toJSON().fontSize}export default class Active extends State{constructor(e,t,a){super(e,t);let r,s,n,i,o,E,c=this;c.shapes=[];const h=function(){E=c.shapes.map(function(e){return e.save(c)})};c.clearHandler=function(){c.setShapes(a,[])},c.shapeEnterHandler=function(e){let{shape:t}=e;t.state||(o=t)},c.shapeLeaveHandler=function(){o&&(o=null)},c.mouseDownHandler=function(e){if(r>=0){const e=c.x,t=c.y,a=e+c.width,o=t+c.height;switch(r){case LEFT_TOP:i=updateRect(c,a,o);break;case CENTER_TOP:s=e,i=updateRect(c,a,o);break;case RIGHT_TOP:i=updateRect(c,e,o);break;case RIGHT_MIDDLE:n=o,i=updateRect(c,e,t);break;case RIGHT_BOTTOM:i=updateRect(c,e,t);break;case CENTER_BOTTOM:s=a,i=updateRect(c,e,t);break;case LEFT_BOTTOM:i=updateRect(c,a,t);break;case LEFT_MIDDLE:n=o,i=updateRect(c,a,t)}h()}else if(o){array.has(c.shapes,o)||c.setShapes(a,[o]);const t=e.x-c.x,r=e.y-c.y;i=function(e,a){c.x=e-t,c.y=a-r},h()}else e.inCanvas&&c.shapes.length&&c.setShapes(a,[])},c.mouseMoveHandler=function(e){if(i)return i(s||e.x,n||e.y),t.fire(Emitter.ACTIVE_RECT_CHANGE_START),array.each(c.shapes,function(e,t){e.restore(c,E[t])}),void t.fire(Emitter.ACTIVE_RECT_CHANGE_END);let o,h=c.isPointInPath(a,e.x,e.y);if(!1!==h){if(r!==h)switch(r=h,h){case CENTER_TOP:case CENTER_BOTTOM:o="ns";break;case RIGHT_MIDDLE:case LEFT_MIDDLE:o="ew";break;case LEFT_TOP:case RIGHT_BOTTOM:o="nwse";break;case RIGHT_TOP:case LEFT_BOTTOM:o="nesw"}}else r>=0&&(o="",r=-1);null!=o&&t.fire(Emitter.ACTIVE_DRAG_BOX_HOVER,{name:o})},c.mouseUpHandler=function(e){r>=0&&(r=-1,t.fire(Emitter.ACTIVE_DRAG_BOX_HOVER,{name:""})),i=s=n=null},c.resetUpHandler=function(e){r>=0&&c.mouseUpHandler(e),c.setShapes(a,[])},c.on(Emitter.CLEAR,c.clearHandler).on(Emitter.SHAPE_ENTER,c.shapeEnterHandler).on(Emitter.SHAPE_LEAVE,c.shapeLeaveHandler).on(Emitter.MOUSE_DOWN,c.mouseDownHandler).on(Emitter.MOUSE_MOVE,c.mouseMoveHandler).on(Emitter.MOUSE_UP,c.mouseUpHandler).on(Emitter.RESET,c.resetUpHandler)}destroy(){this.off(Emitter.CLEAR,this.clearHandler).off(Emitter.SHAPE_ENTER,this.shapeEnterHandler).off(Emitter.SHAPE_LEAVE,this.shapeLeaveHandler).off(Emitter.MOUSE_DOWN,this.mouseDownHandler).off(Emitter.MOUSE_MOVE,this.mouseMoveHandler).off(Emitter.MOUSE_UP,this.mouseUpHandler).off(Emitter.RESET,this.resetUpHandler)}getShapes(){return this.shapes}setShapes(e,t){if(t.length>0){let a=getUnionRect(t.map(function(t){return t.getRect(e)}));object.extend(this,a)}else this.width=this.height=0;this.shapes=t,this.emitter.fire(Emitter.ACTIVE_SHAPE_CHANGE,{shapes:t})}isPointInPath(e,t,a){const{boxes:r,thumbSize:s}=this;if(r)for(let e,n,i=0,o=r.length;i<o;i+=2)if(e=r[i],n=r[i+1],t>=e-s&&t<=e+2*s&&a>=n-s&&a<=n+2*s)return i/2;return!1}draw(e){let t,{shapes:a,x:r,y:s,width:n,height:i}=this,{length:o}=a;if(o&&(e.disableShadow(),e.setLineWidth(1),o>1?(t=!0,e.setStrokeStyle("#C0CED8"),array.each(a,function(a){let r=a.getRect(e);e.strokeRect(r.x+.5,r.y+.5,r.width,r.height),t&&!isTextShape(a)&&(t=!1)})):t=isTextShape(a[0]),e.setStrokeStyle("#ccc"),e.begin(),e.drawRect(r+.5,s+.5,n,i),e.stroke(),!t)){e.setStrokeStyle("#a2a2a2"),e.enableShadow(0,2,3,"rgba(0,0,0,0.2)");const t=this.thumbSize=6*constant.DEVICE_PIXEL_RATIO,a=r-t/2,o=r+(n-t)/2,E=r+n-t/2,c=s-t/2,h=s+(i-t)/2,T=s+i-t/2,l=[a,c,o,c,E,c,E,h,E,T,o,T,a,T,a,h];for(let a,n=0,i=l.length;n<i;n+=2)r=l[n],s=l[n+1],(a=e.createLinearGradient(r,s+t,r,s)).addColorStop(0,"#d6d6d6"),a.addColorStop(1,"#f9f9f9"),e.begin(),e.setFillStyle(a),e.drawRect(r,s,t,t),e.stroke(),e.fill();this.boxes=l,e.disableShadow()}}};