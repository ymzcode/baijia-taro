var sendBroadcast,getCachedBroadcast,broadcastFilter,store=require("./store"),config=require("./config"),roomServer=require("./server/room"),eventEmitter=require("./eventEmitter"),BROADCAST_EXCEPTION="BroadcastException",BROADCAST_EXCEPTION_NOT_ALLOWED=1,BROADCAST_EXCEPTION_TOO_LONG=2,BROADCAST_EXCEPTION_TOO_FREQUENT=3,signalQueue=[],customcastHandle={};exports.init=function(){var e=store.get("partner.liveCustomBroadcastSignal"),t=function(e,t,r){var n=r.fromId,a=customcastHandle[r.key];a&&a(n,r.value,e)};e&&e.keys?(sendBroadcast=roomServer.sendBroadcast,getCachedBroadcast=function(e){roomServer.getCachedBroadcast({key:e})},broadcastFilter=function(t,r){if(-1===e.keys.indexOf(t))throw{name:BROADCAST_EXCEPTION,code:BROADCAST_EXCEPTION_NOT_ALLOWED,message:"Illegal key"};if(JSON.stringify(r).length>e.maxLength)throw{name:BROADCAST_EXCEPTION,code:BROADCAST_EXCEPTION_TOO_LONG,message:"Size exceeded"};return!0},eventEmitter.on(eventEmitter.BROADCAST_RECEIVE,t.bind(null,!1)).on(eventEmitter.BROADCAST_CACHE_RES,t.bind(null,!0))):(sendBroadcast=roomServer.sendCustomcast,getCachedBroadcast=function(e){roomServer.getCachedCustomcast({key:e})},broadcastFilter=function(){return!0},eventEmitter.on(eventEmitter.CUSTOMCAST_RECEIVE,t.bind(null,!1)).on(eventEmitter.CUSTOMCAST_CACHE_RES,t.bind(null,!0)))},exports.sendBroadcast=function(e,t,r){if(broadcastFilter(e,t)){var n=+new Date,a=signalQueue.length,o=signalQueue[a-5]?signalQueue[a-5]:-1,s=signalQueue[a-30]?signalQueue[a-30]:-1;if(!(n-o>config.SECOND&&n-s>config.MINUTE))throw{name:BROADCAST_EXCEPTION,code:BROADCAST_EXCEPTION_TOO_FREQUENT,message:"Frequency exceeded"};signalQueue.push(n),sendBroadcast({key:e,value:t,options:r}),a>60&&signalQueue.shift()}},exports.onReceiveBroadcast=function(e,t){customcastHandle[e]=t},exports.getCachedBroadcast=function(e){return getCachedBroadcast(e)};