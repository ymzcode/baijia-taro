var eventEmitter=require("../../eventEmitter"),live=require("../../server/live"),store=require("../../store"),language=require("../../language/main")(),classData=require("../../data/class"),userSpeak=require("../../userSpeak"),waitingServerInfo=!1,waitingStatus=null,firstMediaPublishTriggered=!1,LOCAL_CLOSE_MIC_BY_TEACHER_OR_ASSISTANT="local_close_mic_by_teacher_or_assistant",auth=require("../../auth"),info=require("../../info");function triggerPublish(e){var t=store.get("user");t&&t.publishServer?(console.log("trigger media publish in publisher"),eventEmitter.trigger(eventEmitter.MEDIA_PUBLISH_TRIGGER,{videoOn:e.videoOn,audioOn:e.audioOn})):(waitingServerInfo=!0,waitingStatus=e)}Component({properties:{styleInfo:{type:Object,value:{fontSize:12,color:"black"}},beauty:{type:Number,value:0},whiteness:{type:Number,value:0},autoFocus:{type:Boolean,value:!0},aspect:{type:String,value:"3:4"},backgroundMute:{type:Boolean,value:!1},orientation:{type:String,value:"vertical"},minBitrate:{type:Number,value:200},maxBitrate:{type:Number,value:1e3},waitingImage:{type:String,value:""},waitingImageHash:{type:String,value:""},zoom:{type:Boolean,value:!1}},data:{streamName:"",name:language.ME,status:{audioOn:!1,videoOn:!1}},ready:function(){var e=this;firstMediaPublishTriggered=!1,eventEmitter.on(eventEmitter.SERVER_INFO_FETCH_SUCCESS,function(t,i){console.log("push stream name:",live.getUplinkStreamName(store.get("user"))),e.setData({streamName:live.getUplinkStreamName(store.get("user"))}),waitingServerInfo&&(triggerPublish(waitingStatus),waitingServerInfo=!1)}).on(eventEmitter.SWITCH_CAMERA,function(t,i){wx.createLivePusherContext(e).switchCamera()}).on(eventEmitter.SPEAK_INVITE_CONFIRM,function(){info.confirm({content:language.LABEL_TEACHER_SPEAK_INVITING,cancelText:language.REJECT}).then(function(){userSpeak.processInvite(!0)},function(){userSpeak.processInvite(!1)})}).on(eventEmitter.MEDIA_PUBLISH_DENY,function(e,t){info.tip(language.SERVER_CONCURRENCY_REJECT),eventEmitter.trigger(eventEmitter.MEDIA_SWITCH_TRIGGER,{audioOn:!1,videoOn:!1})}).on(eventEmitter.PAGE_HIDE,function(e,t){eventEmitter.trigger(eventEmitter.MEDIA_SWITCH_TRIGGER,{videoOn:!1,audioOn:!1})}).on(eventEmitter.MEDIA_SWITCH_TRIGGER,function(t,i){var n=store.get("user.audioOn"),a=store.get("user.videoOn"),r=void 0===i.videoOn?a:i.videoOn,o=void 0===i.audioOn?n:i.audioOn,u=i.operator;i.auto&&(r||o)&&classData.get(LOCAL_CLOSE_MIC_BY_TEACHER_OR_ASSISTANT)||(e.setStatus({videoOn:r,audioOn:o}),u&&auth.isStudent()&&!auth.isStudent(u.type)&&(n!==o&&a===r&&(o?(classData.remove(LOCAL_CLOSE_MIC_BY_TEACHER_OR_ASSISTANT),info.tip(language.INFO_HAS_BEEN_OPENED_WEBMIC)):(classData.set(LOCAL_CLOSE_MIC_BY_TEACHER_OR_ASSISTANT,store.get("user.number")),info.tip(language.INFO_HAS_BEEN_CLOSED_WEBMIC))),a!==r&&n===o&&(r?info.tip(language.INFO_HAS_BEEN_OPENED_WEBCAM):info.tip(language.INFO_HAS_BEEN_CLOSED_WEBCAM))),r||o||u&&u.id===store.get("teacher.id")&&info.tip(language.INFO_END_SPEAK_BY_TEACHER))})},methods:{setStatus:function(e){var t=this.data.status;JSON.stringify(t)!=JSON.stringify(e)&&(this.setData({status:e}),triggerPublish(e),store.set("user.audioOn",e.audioOn),store.set("user.videoOn",e.videoOn),this.triggerEvent("statusChange",{newValue:e,oldValue:t}))},onTap:function(e){this.triggerEvent("publisherTap",{event:e,user:store.get("user")})},onStateChange:function(e){this.triggerEvent("stateChange",e)},onNetStatus:function(e){this.triggerEvent("netStatusInfo",e)},onError:function(e){this.triggerEvent("error",e)}}});