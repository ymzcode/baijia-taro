var chatServer=require("../../server/chat"),isSameChannel=require("../../function/isSameChannel"),util=require("../../util"),config=require("../../config"),userData=require("../../data/user"),parser=require("../../parser"),$=require("../../jquery"),string=require("../../string"),eventEmitter=require("../../eventEmitter"),auth=require("../../auth"),store=require("../../store"),language=require("../../language/main")(),info=require("../../info"),getDocumentImageDimension=require("../../function/getDocumentImageDimension");function isSelf(e){return e.number===store.get("user.number")}function needDivider(e,t){var a=2*config.MINUTE;if(a)return!t||e.time-t.time>a}$.extend(language,require("./language/main")()),Component({properties:{channel:{type:"string"},maxCount:{type:"number",value:200},historySize:{type:"number",value:10},shortContentSize:{type:"number",value:80},styleInfo:{type:"Object",value:{messageBackground:"white",fromColor:"#9E9DA0",contentColor:"black"}}},data:{data:[],language:language,hasMore:!0,fetching:!1,showImageMask:!1,zoomImage:{}},ready:function(){var e=this;e.namespace=".message_list"+Math.random();var t=function(e){var t=e&&e.content;if(t&&util.is.string(t))return t.indexOf("<img ")>=0},a=function(){};eventEmitter.on(eventEmitter.MESSAGE_PULL_RES+e.namespace,function(a,n){if(e.isSameChannel(n.channel)){e.setData({fetching:!1,hasMore:n.hasMore});e.data.data.length;util.array.each(n.messageList,function(a){t(e.prependMessage(a))&&!0})}}).on(eventEmitter.MESSAGE_RECEIVE+e.namespace,function(n,r){var i;e.isSameChannel(r.channel)&&(i=e.appendMessage(r))&&t(i)&&a()}).on(eventEmitter.CHAT_SERVER_LOGIN_SUCCESS,function(){e.setData({hasMore:!0}),e.clearData(),e.fetchMore()}).on(eventEmitter.MESSAGE_LIST_CLEAR+e.namespace,function(t,a){e.clearData(a.channel)}),console.log("message list ready");var n=chatServer.socket;n&&n.isOpen()&&e.fetchMore()},methods:{clearData:function(e){this.setData({data:[]})},fetchMore:function(e){var t=this.data;t.hasMore&&!t.fetching&&(this.setData({fetching:!0}),eventEmitter.trigger(eventEmitter.MESSAGE_PULL_REQ,{channel:t.channel,count:t.historySize,next:e}),eventEmitter.trigger(eventEmitter.STICKY_NOTICE_REQ))},validate:function(e){return $.trim(e.content)&&e.from.status===config.USER_STATUS_ONLINE},format:function(e){var t,a,n=e.from,r=e.data,i=e.content,o=e.custom,s=e.to;this.data.renderContent;var u=function(){var e=$.extend(!0,{},n),t=e.type;return(auth.isTeacher(t)||auth.isAssistant(t))&&(e.roleName="teacher"),auth.isStudent(t)&&(e.roleName="student"),isSelf(n)&&(e.name=language.ME,e.roleName="self"),e}();if(s){var m=userData.find(s);m&&(t=m.name)}if(!o)if(r&&r.type)e.type=r.type,"emoji"===r.type?(e.key=r.key,e.url=r.url||parser.getEmojiUrlByKey(r.key)):"image"===r.type&&(e.url=r.url,e.height=r.height,e.width=r.width),a=i="";else if(e.type="text",i=$.trim(i),parser.isPureText(i)){var g=auth.isSelf(n.id)?language.ME:u.name,h=string.size(g);a=string.cut(i,this.data.shortContentSize-(h>12?12:h))}else{var c=parser.parseEmoji(i);c.url&&(e.url=c.url,e.type="emoji");var l=parser.parseImage(i);l&&(e.url=l,e.type="image"),a=""}var d=e.channel;return"string"!==$.type(d)&&(d=$.type(d)),r={id:e.id,type:e.type,url:e.url,number:d+(e.id||""+Math.random()),user:u,receiver:t,time:e.time?1e3*e.time:$.now(),custom:o,content:i,key:e.key,width:e.width,height:e.height,shortContent:a,fromColor:this.data.styleInfo.fromColor}},prependMessage:function(e){var t=this;if(t.validate(e)){var a=t.data.data,n=a[0];if(!n||e.id!=n.id)return e=t.format(e),a.unshift(e),t.setData({data:a}),t.triggerEvent("addMessage",{message:e}),e}},appendMessage:function(e){var t=this;if(t.validate(e)){var a=t.data.data,n=a[a.length-1];if(e.to!==config.MESSAGE_TO_ALL||!n||e.id!=n.id){(e=t.format(e)).needDivider=needDivider(e,a[a.length]),a.push(e);var r=t.data.maxCount;return r>0&&a.length>r&&(a=a.slice(1)),t.setData({data:a}),t.triggerEvent("addMessage",{message:e}),e}}},isSameChannel:function(e){return isSameChannel(this.data.channel,e)},onImageMaskTap:function(){this.setData({showImageMask:!1})},onZoomImageError:function(){info.alert("image load fail"),info.hideLoading()},onZoomImageLoad:function(){info.hideLoading()},imageTap:function(e){var t=e.target.dataset,a=wx.getSystemInfoSync(),n=(this.data.zoomImage.url,getDocumentImageDimension(a.windowWidth,a.windowHeight,t.width,t.height,config.DOC_FIT_VIEW,!0,1));this.setData({showImageMask:!0,zoomImage:{url:t.src+"?v="+(new Date).getTime(),width:n.width,height:n.height}})}}});