var config=require("../../config"),info=require("../../info"),eventEmitter=require("../../eventEmitter"),$=require("../../jquery"),emotionData=require("../../data/emotion"),appLanguage=require("../../language/main")(),pageLanguage=require("./language/main")();function isReservedWord(e){for(var t,n=[config.DEBUG_KEY,config.OPEN_VCONSOLE],a=0;t=n[a++];)if(t==e)return!0;return!1}Object.assign(pageLanguage,appLanguage),Component({properties:{placeholder:{type:"String",value:""},messageMaxLength:{type:"Number",value:140},focus:{type:"Boolean",value:!1},isBJY:{type:"Boolean",value:!1},confirmHold:{type:"Boolean",value:!1}},data:{forbidden:!1,allForbidden:!1,language:pageLanguage,content:"",messageValue:"",emotionList:[],messageCommand:"",isCommandInputError:!1},methods:{triggerEmotionToggle:function(){var e=this,t=wx.createSelectorQuery().in(e);t.select("#bjy-message-sender").boundingClientRect(),t.exec(function(t){e.triggerEvent("heightChange",{height:t[0].height,top:t[0].top,showEmotion:e.data.showEmotion})})},iconTap:function(e){var t=e.target.dataset.name;"emotion"==t?this.setData({showEmotion:!0}):"inEmotion"==t&&this.setData({showEmotion:!1,focus:!0}),this.triggerEmotionToggle()},emotionTap:function(e){this.sendEmoji(e.detail),this.setData({showEmotion:!1}),this.triggerEmotionToggle()},sendEmoji:function(e){eventEmitter.trigger(eventEmitter.MESSAGE_SEND,{content:e.stringify,data:{type:"emoji",key:e.key,url:e.url}}),this.triggerEvent("sendMessage",{content:e.stringify})},validate:function(){var e=this,t=e.data,n=t.content,a=t.messageCommand,i=t.messageMaxLength;t.language;if(!(i>0&&n.length>i))return a&&a!==n&&(this.setData({isCommandInputError:!0}),setTimeout(function(){e.data.isCommandInputError&&e.setData({isCommandInputError:!1})},1e3)),this.setData({confirmHold:!1}),!0;info.alert(getLanguage().ERROR_TOO_LONG)},inputFocus:function(){this.triggerEvent("inputFocus")},inputBlur:function(){this.triggerEvent("inputBlur")},sendMessage:function(e){var t=this,n=$.trim(e.detail.value);t.setData({content:n}),n&&t.validate()&&(t.setData({messageValue:""}),t.data.isBJY&&isReservedWord(n)||eventEmitter.trigger(eventEmitter.MESSAGE_SEND,{content:n}),t.triggerEvent("sendMessage",{content:n,command:t.data.messageCommand}))}},ready:function(){var e=this;e.namespace=".message_sender",0!=emotionData.all().length?e.setData({emotionList:emotionData.all()}):eventEmitter.on(eventEmitter.INTERFACE_FETCH_SUCCESS,function(){e.setData({emotionList:emotionData.all()})}),eventEmitter.on(eventEmitter.STANDARD_LOTTERY_END+e.namespace,function(){e.setData({focus:!1})}).on(eventEmitter.COMMAND_LOTTERY_ABORT+e.namespace,function(t,n){e.setData({messageCommand:"",focus:!1})}).on(eventEmitter.LOTTERY_BOX_CLICKED+e.namespace,function(t,n){e.setData({content:"",messageCommand:n.command})}).on(eventEmitter.COMMAND_LOTTERY_HIT_RES+e.namespace,function(t,n){e.setData({isCommandInputError:!1,messageCommand:""})})}});