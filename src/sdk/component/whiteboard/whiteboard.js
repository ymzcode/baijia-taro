var loadedImageUrl,pageChangeData,auth=require("../../auth"),store=require("../../store"),config=require("../../config"),docData=require("../../data/doc"),pageData=require("../../data/page"),eventEmitter=require("../../eventEmitter"),$=require("../../jquery"),loading=require("./loading"),getDocumentImageDimension=require("../../function/getDocumentImageDimension"),toNumber=require("../../function/toNumber"),language=require("../../language/main")(),pageInfo={},touchTime=0,touchDot=0,touchInterval="",systemInfo=wx.getSystemInfoSync();function requestAll(){eventEmitter.trigger(eventEmitter.DOC_ALL_REQ)}var pageEnd=function(e){eventEmitter.trigger(eventEmitter.PAGE_CHANGE_END,pageInfo)},changePage=function(e,t){var a=docData.getComplexPage(e);eventEmitter.trigger(eventEmitter.PAGE_CHANGE_TRIGGER,{docId:a.docId,page:a.page,step:t})};Component({properties:{canUsePptSelection:{type:Boolean,value:!1},canDraw:{type:Boolean,value:!0},showClear:{type:Boolean,value:!0},hidePageCount:{type:Boolean,value:!0,observer:function(e,t){0==pageInfo.page?this.setData({showPageCount:!0}):this.setData({showPageCount:!e})}},drawing:{type:Boolean,value:!1},size:{type:Object,value:{width:systemInfo.windowWidth,height:Math.ceil(3*systemInfo.windowWidth/4)},observer:function(e,t){e&&t&&eventEmitter.trigger(eventEmitter.WHITEBOARD_RESIZE)}},styleInfo:{type:"Object",value:{backgroundColor:"white",pageCountColor:"white",pageCountBackground:"#C2C0C1"}}},data:{oriSize:null,pageInfo:{},language:language,pageCount:"",finished:!1,showPageCount:!1,currentPage:0,showPptSelection:!1,showNext:!1,showPrev:!1,isWhiteboardFullScreen:!1},ready:function(){var e=this;function t(t,a){var n=a.docId,o=a.page,i=docData.getDocumentById(n);i&&($.extend(pageInfo,i.pageList[o]),e.getImageDimension(pageInfo.width,pageInfo.height,function(t){var a=docData.getSimplePage(n,o).page;pageInfo.docId=n,pageInfo.docPage=o,pageInfo.page=a,pageInfo.rawWidth=+pageInfo.width,pageInfo.rawHeight=+pageInfo.height,docData.getQuality(),loadedImageUrl=null,pageChangeData=pageInfo,pageInfo.hasPrevPage=pageData.hasPrevPage(a),pageInfo.hasNextPage=pageData.hasNextPage(a),pageInfo.width=t.width,pageInfo.height=t.height;var i=docData.getWhiteboardPageCount(),g={pageInfo:pageInfo,pageCount:"  "+(i>1?pageInfo.page+1+"/"+docData.getTotalPages():language.WHITE_BOARD)+"  "};g.showPageCount=!e.data.hidePageCount||0==pageInfo.page,e.setData(g),eventEmitter.trigger(eventEmitter.PAGE_CHANGE_START,pageInfo)}))}$.extend(config,require("./config")),$.extend(eventEmitter,require("./eventEmitter")),eventEmitter.on(eventEmitter.PAGE_PREV_TRIGGER,function(){auth.canPage()&&pageData.prevPage()&&changePage(pageData.getClientPage())}).on(eventEmitter.PAGE_NEXT_TRIGGER,function(){auth.canPage()&&pageData.nextPage()&&changePage(pageData.getClientPage())}),loading.init(),eventEmitter.on(eventEmitter.SERVER_PAGE_CHANGE,t).on(eventEmitter.WHITEBOARD_DRAWING_CHANGE,function(t,a){e.setData({drawing:a.drawing})}).on(eventEmitter.CLIENT_PAGE_CHANGE,t).on(eventEmitter.CURRENT_PAGE_SHAPE_LOAD_END,pageEnd).on(eventEmitter.CURRENT_DOC_IMAGE_LOAD_SUCCESS,function(t,a){var n=a.rawUrl;e.setData({finished:!0}),n!==loadedImageUrl&&(loadedImageUrl=n,pageEnd())}).on(eventEmitter.DOC_QUALITY_CHANGE_TRIGGER,function(e,t){var a=toNumber(t.value);a!==docData.getQuality()&&(t.value=a,docData.setQuality(a),exports.refresh(),eventEmitter.trigger(eventEmitter.DOC_QUALITY_CHANGE,t))}).on(eventEmitter.WHITEBOARD_RESIZE,function(t,a){e.resize()}).on(eventEmitter.ROOM_SERVER_LOGIN_SUCCESS,function(){store.get("isClassSwitching")||requestAll()})},methods:{toggleWhiteboardFullScreen:function(){var e=this.data;e.isWhiteboardFullScreen||(e.oriSize=e.size),this.setData({isWhiteboardFullScreen:!e.isWhiteboardFullScreen,size:e.isWhiteboardFullScreen?e.oriSize:{width:systemInfo.windowWidth,height:systemInfo.windowHeight}})},onPageCountTap:function(){console.log("onPageCountTap");this.data.showPptSelection;this.data.canUsePptSelection&&this.setData({showPptSelection:!0})},getImageDimension:function(e,t,a){wx.createSelectorQuery();var n=this.data;a(getDocumentImageDimension(n.size.width,n.size.height,e,t,docData.getFit(),!0,1),pageInfo)},resize:function(){var e=this;console.log("whiteboard resize"),e.getImageDimension(pageInfo.rawWidth,pageInfo.rawHeight,function(t){pageInfo.width=t.width,pageInfo.height=t.height,e.setData({pageInfo:pageInfo})})},touchStart:function(e){this.data.drawing||(touchDot=e.touches[0].pageX,touchInterval=setInterval(function(){touchTime++},100))},showNext:function(){var e=this;e.setData({showNext:!0}),setTimeout(function(){e.setData({showNext:!1})},500)},showPrev:function(){var e=this;e.setData({showPrev:!0}),setTimeout(function(){e.setData({showPrev:!1})},500)},touchEnd:function(e){if(!this.data.drawing){var t=e.changedTouches[0].pageX;t-touchDot<=-config.TOUCH_DISTANCE&&touchTime<config.TOUCH_TIME&&(this.showNext(),eventEmitter.trigger(eventEmitter.PAGE_NEXT_TRIGGER)),t-touchDot>=config.TOUCH_DISTANCE&&touchTime<config.TOUCH_TIME&&(this.showPrev(),eventEmitter.trigger(eventEmitter.PAGE_PREV_TRIGGER)),clearInterval(touchInterval),touchTime=0}},onWhiteboardTap:function(){this.triggerEvent("whiteboardTap")},onClearTap:function(e){eventEmitter.trigger(eventEmitter.CLEAR_CANVAS)},onPptImageTap:function(e){var t=e.detail.item,a=docData.getComplexPage(t.page);eventEmitter.trigger(eventEmitter.CLIENT_PAGE_CHANGE,{docId:a.docId,page:a.page})}}});