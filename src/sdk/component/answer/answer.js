var answerInterval,eventEmitter=require("../../eventEmitter"),$=require("../../jquery"),store=require("../../store"),info=require("../../info"),util=require("../../util"),config=require("../../config"),pageLanguage=require("./language/main")();Component({properties:{},data:{language:pageLanguage,showAnswer:!1,isJudgement:!1,showResult:!1,showCloseButton:!0,autoCloseAfterEnd:!1,autoCloseAfterSubmit:!1,autoShowResultAfterEnd:!1,options:[],duration:0,startCountDownTime:0,description:"",fromId:"",locked:!0,countDownTime:"",canAnswer:!0,canReset:!1,rightOptions:[],currentValueStr:""},ready:function(){var t=this;t.namespace=".answer"+Math.random(),eventEmitter.on(eventEmitter.START_ANSWER+t.namespace,(e,n)=>{info.tip(pageLanguage.ANSWER_SUBMIT),n.showResult=!1,t.initData(n),t.setData({showAnswer:!0,canAnswer:!0,canReset:!1})}).on(eventEmitter.END_ANSWER+t.namespace,(e,n)=>{if(!t.data.showResult){answerInterval&&clearInterval(answerInterval),t.setData({countDownTime:0,canAnswer:!1,canReset:!1,showAnswer:!1}),info.tip(pageLanguage.ANSWER_END);var a=t.data.options.filter(function(t){return t.isSelected});!n.isRevoke&&t.data.autoShowResultAfterEnd&&(a.length||t.data.rightOptions.length)&&eventEmitter.trigger(eventEmitter.ANSER_RESULT_SHOW,{options:t.data.options,isJudgement:t.data.isJudgement})}}).on(eventEmitter.ANSER_RESULT_SHOW+t.namespace,(e,n)=>{t.setData({showResult:!0,showAnswer:!0})}).on(eventEmitter.ANSWER_SUBMIT_TRIGGER+t.namespace,function(t,e){eventEmitter.trigger(eventEmitter.COMMAND_SEND,{to:e.toUserId,name:"submit_answer",params:e})})},methods:{initData:function(t){var e=this;e.setData({autoShowResultAfterEnd:!!t.isShowCorrectAnswer,showResult:t.showResult,isJudgement:null==t.isJudgement?t.type===config.ANSWER_TYPE_JUDGEMENT:t.isJudgement,options:t.options,rightOptions:t.options.filter(function(t){return t.isRight}),duration:t.duration,description:t.description,fromId:t.fromId,startCountDownTime:Date.now(),showResult:t.showResult});var n=[];$.each(e.data.rightOptions,function(t,e){n.push(e.text)}),e.setData({currentValueStr:n.join(" ")}),t.showResult||(answerInterval=setInterval(function(){var t=e.data.duration-(Date.now()-e.data.startCountDownTime)/1e3;t>0?e.setData({countDownTime:util.formatTime(t)}):(e.setData({canAnswer:!1}),clearInterval(answerInterval))},1e3))},optionClick:function(t){var e=this,n=t.target.dataset.index;if(e.data.canAnswer){e.data.rightOptions.length<=1&&e.setData({options:e.data.options.map(function(t){return t.isActive=!1,t})});var a=e.data.options[n].isActive;e.setData({["options["+n+"].isActive"]:!a,locked:!1})}},submitAnswer:function(){var t=this.data;eventEmitter.trigger(eventEmitter.ANSWER_SUBMIT_TRIGGER+this.namespace,{timeUsed:Math.round((Date.now()-t.startCountDownTime)/1e3),options:t.options,toUserId:t.fromId,group:store.get("user.group",0)}),this.setData({canAnswer:!1,canReset:!0})},submit:function(){var t=this.data,e=t.options.filter(function(t){return t.isActive});this.setData({options:t.options.map(function(t){return t.isSelected=t.isActive,t})}),e.length?t.isJudgement&&e.length>1?info.tip(pageLanguage.ANSWER_JUDGEMENT_SUBMIT_STUDENT_ERROR):(info.tip(pageLanguage.ANSWER_SUBMIT_SUCCESS),this.submitAnswer()):info.tip(pageLanguage.ANSWER_SUBMIT_STUDENT_ERROR)},reset:function(){this.setData({canAnswer:!0,canReset:!1,options:this.data.options.map(function(t){return t.isActive=!1,t})})},hide:function(){this.setData({showAnswer:!1})}}});